---
title: "ensinaR"
author: "Pedro de Brito Neto"
date: "19/10/2020"
output: html_document
---

# Introdução
 Bruno, descrever o projeto
 
 
 
 
 
Priramente vamos carregar alguns pacotes que iremos útilizar
 
```{r message=FALSE}
library(ggplot2)
library(dplyr)
library(janitor)
library(lubridate)
library(tidyr)
library(tidyverse)
library(ggthemes)
library(forcats)

```


Após carregar o pacote, iremos carregar o conjunto de dados. Uma forma de ler diretamente essa informação no R pode ser feita da seguinte
forma.  

*dados <- read.csv("https://bi.static.es.gov.br/covid19/MICRODADOS.csv",
                  sep = ";",
                  fileEncoding = "ISO-8859-1")  *

Outra maneira de obter a planilha é baixando ela diretamente pelo site e importando do seu computador. Nesse caso,iremos trabalhar dessa forma.  
Agora podemos começar a organizar os dados para fazermos as análises.  

# Filtrando
Como queremos fazer as análises baseada nos casos confirmados, podemos começar aplicando um filtro para selecionarmos apenas os casos confirmados. Depois disso, usaremos um `for` para mudarmos os nomes da variável "Sexo" e por último, criamos uma nova variável chama "Idade" que vai receber apenas os dois primeiros dígitos da varíavel "IdadeNaNotificacao".  
A planilha original possui mais de 400mil observações e para não puxar muita memória do computador iremos usar o código `dados <- dados[sample(1:dim(dados)[1], 20000), ]` que ira restingrir a base de dados para que o computador consiga os códigos de maneira mais rápida

```{r}
dados <- read.csv("C:/Users/pedro/Desktop/MICRODADOS.csv", sep = ";")
dados <- filter(dados, Classificacao=="Confirmados") 
dados <- dados[sample(1:dim(dados)[1], 20000), ]
for(i in 1:nrow(dados)){
  if(dados$Sexo[i]=="F"){dados$Sexo[i] <- "Feminino"}
  if(dados$Sexo[i]=="M"){dados$Sexo[i] <- "Masculino"}
  if(dados$Sexo[i]=="I"){dados$Sexo[i] <- "Ignorados"
  }
}  

dados$Idade <- str_sub(dados$IdadeNaDataNotificacao, end = 2)
```

# Gerando os primeiros gráficos
com essas filtragens, já podemos começar a gerar alguns gráficos interessantes como, por exemplo, a quantidade de casos confirmados separados por faixa etária a quantidade de casos confirmados separados por Raça/Cor e um histograma de frequência separado por sexo. Vale ressaltar, que para gerar o histograma é necessário mudarmos a varíavel "Idade" para numeric, basta útilizar a função `as.numeric`.  

```{r fig.width = 9, fig.height = 7 }
ggplot(dados) + geom_bar(aes(x=FaixaEtaria), fill= "purple")+ 
  labs(y= "Frequência") + scale_y_continuous(breaks = seq(0,100000,500)) + theme_calc()

ggplot(dados) + geom_bar(aes(x=RacaCor, fill= RacaCor)) + scale_y_continuous(breaks = seq(0,100000,1000)) +
  labs(y="Frequência") + theme_bw()

dados$Idade <- as.numeric(dados$Idade)


ggplot(dados, aes(x = Idade, fill=Sexo)) +
  geom_histogram(color= "white",bins = 50) + theme_bw() +
  ylab("Frequência") + scale_fill_manual(values=c("yellow","red","purple"))



```

Uma outra coisa interessanta a ser feita é analisarmos os casos nas regiões do Espirito Santo. Seguimos a divisão feita pelo Governo do Estado que pode ser encontra da [clicando aqui](http://www.ijsn.es.gov.br/mapas/), onde o estado foi dividido nas seguintes regiões: Metropolitana, Central, norte e sul.  
usamos um `for` para atribuirmos cada cidade a sua devida região.


```{r message=FALSE, echo=FALSE}
attach(dados)
regiao <- rep(nrow(dados))

for (i in 1:nrow(dados)){
  if(Municipio[i] =='VITORIA' |Municipio[i] =="DOMINGOS MARTINS"| Municipio[i] =="SANTA LEOPOLDINA"| Municipio[i] =="MARECHAL FLORIANO"|  Municipio[i] =='FUNDAO' | Municipio[i] =='SERRA' | Municipio[i] =='VILA VELHA' | Municipio[i] =='CARIACICA' | Municipio[i] =='VIANA' | Municipio[i] =='GUARAPARI'| Municipio[i] ==" SANTA LEOPOLDINA"| Municipio[i] =="DOMIGOS MARTINS"| Municipio[i] =="MARCHAL FLORIANO"| Municipio[i] =="SANTA TERESA"| Municipio[i] =="SANTA MARIA DO JETIBA"| Municipio[i] =="ITAGUACU"| Municipio[i] =="LARANJA DA TERRA"| Municipio[i] =="ITARANA"| Municipio[i] =="AFONSO CLAUDIO"| Municipio[i] =="VENDA NOVA DO IMIGRANDE"| Municipio[i] =="BREJETUBA"| Municipio[i] =="CONCEICAO DO CASTELO"){regiao[i]<-'Região Metropolitana'}
  if(Municipio[i] =="AGUIA BRANCA"|Municipio[i] =="VENDA NOVA DO IMIGRANTE"|  Municipio[i] =="SANTA MARIA DE JETIBA"| Municipio[i] =="MANTENOPOLIS"| Municipio[i] =="JAGUARE"| Municipio[i] =="SAO MATEUS"| Municipio[i] =="NOVA VENECIA"| Municipio[i] =="BARRA DE SAO FRANCISCO"| Municipio[i] =="VILA PAVAO"| Municipio[i] =="BOA ESPERANCA"| Municipio[i] =="AGUA DOCE DO NORTE"| Municipio[i] =="CONCEICAO DA BARRA"| Municipio[i] =="PINHEIROS"| Municipio[i] =="PEDRO CANARIO"| Municipio[i] =="MONTANHA"| Municipio[i] =="MUCURICI"| Municipio[i] =="PONTO BELO"| Municipio[i] =="ECOPORANGA"){regiao[i]<-'Região Norte'}
  if(Municipio[i] =="ARACRUZ"| Municipio[i] =="IBIRACU"| Municipio[i] =="JOAO NEIVA"| Municipio[i] =="SAO ROQUE DO CANAA"| Municipio[i] =="BAIXO GUANDU"| Municipio[i] =="COLATINA"| Municipio[i] =="MARILANDIA"| Municipio[i] =="LINHARES"| Municipio[i] =="RIO BANANAL"| Municipio[i] =="PANCAS"| Municipio[i] =="SOORETAMA"| Municipio[i] =="GOVERNADOR LINDENBERG"| Municipio[i] =="SAO DOMINGOS DO NORTE" | Municipio[i] =="ALTO RIO NOVO"| Municipio[i] =="SAO GABRIEL DA PALHA"| Municipio[i] =="VILA VALERIO"){regiao[i]<- "Região Central"}
  if(Municipio[i] == 'PRESIDENTE KENNEDY'	|Municipio[i] =="MUQUI"|  Municipio[i] =='MARATAIZES'	| Municipio[i] =='ITAPEMIRIM'	| Municipio[i] =='MIMOSO DO SUL' | Municipio[i] =='APIACA' | Municipio[i] =='BOM JESUS DO NORTE' | Municipio[i] =='SAO JOSE DO CALCADO' | Municipio[i] =="MUQI" | Municipio[i] =="ATILIO VIVACQUA" | Municipio[i] =="PIUMA "| Municipio[i] =="RIO NOVO DO SUL"| Municipio[i] =="CACHOEIRO DE ITAPEMIRIM"| Municipio[i] =="JERONIMO MONTEIRO" | Municipio[i] =="ALEGRE"| Municipio[i] =="GUACUI"| Municipio[i] =="DORES DO RIO PRETO"| Municipio[i] =="DIVINO DE SAO LOURENCO"| Municipio[i] =="IBITIRAMA" | Municipio[i] == "IUNA"| Municipio[i] =="IBATIBA"| Municipio[i] =="IRUPI"| Municipio[i] =="MUNIZ FREIRE"| Municipio[i] =="CASTELO"| Municipio[i] =="VARGEM ALTA"| Municipio[i] =="ALFREDO CHAVES"| Municipio[i] =="ANCHIETA"| Municipio[i] ==" ICONHA"| Municipio[i] =="RIO NOVO DO SUL"| Municipio[i] =="PIUMA"| Municipio[i] =="ICONHA"){regiao[i]<-'Região Sul'}
}
dados$regiao <- regiao

```

Devido ao tamanho do código, optamos por não exibilo. Havia presente na planilha alguns dados de fora do estado, do Rio de Janeiro por exemplo, como queremos análisar apenas o Espirito Santo, aplicamos um filtro para pegar apenas as cidade que foram atribuídas à uma das 4 regiões


```{r}
dados2 <- dados %>%
  filter(regiao=="Região Central" |regiao== "Região Metropolitana" |regiao=="Região Norte"| regiao=="Região Sul") 

dados2 <- rename(dados2, região="regiao")

```
Pronto, agora conseguiremos ver de uma forma clara a quantidade de casos em casa região


```{r}
ggplot(dados2) + geom_bar(aes(x=região,fill=região)) + scale_y_continuous(breaks = seq(0,100000,2000)) +
  labs(y="Frequência") + theme_bw() 

```


Podemos notar o quanto a região metropolitana se destaca em relação as outras, a grosso modo, possui mais casos confirmados do que as outras 3 regiões juntas. A região norte foi a que menos registrou casos.  

Agora, iremos análisar em cada uma dessas regiões, os casos confirmados separados por sexo e raça/cor. Uma observação a ser feita é, como não possui nenhum caso com sexo classificado como "indeterminado" fizemos um filtro para tirar essa observação do gráfico, apenas para fim estético.


os códigos abaixos foram repetidos para cada uma das regiões, mudando apenas o parâmetro
```{r}
regiao_m <-dados2 %>% 
  filter(dados2$região=="Região Metropolitana", dados2$Sexo=="Masculino"|dados2$Sexo=="Feminino") 

ggplot(regiao_m) + geom_bar(aes(RacaCor, fill=Sexo), position = "dodge") + scale_y_continuous(breaks = seq(0,100000,500)) +
  labs(y="Frequência",x="Raça/Cor",title = "Região Metropolitana ") + theme_bw() + scale_fill_manual(values=c("yellow","purple"))
```
    
    
    
    
    
```{r message = F, echo=F}
regiao_c <-dados2 %>% 
  filter(dados2$região=="Região Central",dados2$Sexo=="Masculino"|dados2$Sexo=="Feminino")

regiao_n <-dados2 %>% 
  filter(dados2$região=="Região Norte",dados2$Sexo=="Masculino"|dados2$Sexo=="Feminino")

regiao_s <-dados2 %>% 
  filter(dados2$região=="Região Sul",dados2$Sexo=="Masculino"|dados2$Sexo=="Feminino")

ggplot(regiao_m) + geom_bar(aes(RacaCor, fill=Sexo), position = "dodge") + scale_y_continuous(breaks = seq(0,100000,500)) +
  labs(y="Frequência",x="Raça/Cor",title = "Região Metropolitana ") + theme_bw() + scale_fill_manual(values=c("yellow","purple"))

ggplot(regiao_c) + geom_bar(aes(RacaCor, fill=Sexo), position = "dodge") + scale_y_continuous(breaks = seq(0,100000,100)) +
  labs(y="Frequência",x="Raça/Cor",title = "Região Central ") + theme_bw() + scale_fill_manual(values=c("yellow","purple")) 

ggplot(regiao_n) + geom_bar(aes(RacaCor, fill=Sexo), position = "dodge") + scale_y_continuous(breaks = seq(0,100000,100)) +
  labs(y="Frequência",x="Raça/Cor",title = "Região Norte") + theme_bw() + scale_fill_manual(values=c("yellow","purple"))

ggplot(regiao_s) + geom_bar(aes(RacaCor, fill=Sexo), position = "dodge") + scale_y_continuous(breaks = seq(0,100000,100)) +
  labs(y="Frequência",x="Raça/Cor",title = "Região Sul") + theme_bw() + scale_fill_manual(values=c("yellow","purple"))
```

Ao olharmos para os gráficos dessas regiões podemos tirar algumas conclusões. De forma geral, ao olharmos para a variável sexo, o feminino é maior em relação ao masculino em quase todas as situações com algumas exceções, como por exemplo, na raça classificada como "ignorado". Se olharmos agora para a variável raça/cor, é visível que a classificação branca e parda aparecem muito mais em relação as outras, a raça indígina, apesar de frequente em todas as 4 regiões, tem uma presença muito pequena aparecendo mais na região central.

Agora queremos observar a distribuição dos casos, separados por sexo, ao longo do tempo.  




```{r message=F}
dados <- dados %>% 
  mutate(DataNotificacao = as.Date(DataDiagnostico))
casos_t <- dados %>%
  group_by(Sexo, DataNotificacao) %>%
  summarise(n_casos = n()) %>%
  tidyr::complete(tidyr::nesting(Sexo), 
                  DataNotificacao = seq.Date(min(dados$DataNotificacao),
                                             max(dados$DataNotificacao), 
                                             by = "day"), 
                  fill = list(n_casos = 0)) %>%
  mutate(casos_acumulados = cumsum(n_casos))
ggplot(casos_t) + 
  theme_minimal() + 
  aes(x = DataNotificacao, y = casos_acumulados, color = Sexo) +
  geom_line() +
  scale_color_viridis_d() + 
  labs(y = "Número de casos acumulados", 
       x = "Data Diagnóstico")
```

Observando o gráfico de casos acumulados separado por sexo, podemos ver de forma mais clara o que foi dito antes, o sexo femino tem uma frequência consideravelmente maior em relação ao masculino e foi maior em todo o intervalo de tempo analisado.  

Uma última coisa interessante a ser feita, é análisar a taxa de letalidade da COVID-19. Para fazer isso precisamos calcular essa taxa e separar com as variáveis que queremos exibir no gráfico.  

Para fazer criamos um DataFrame chamado "casos" que vai agrupar as variáveis "RacaCor" e "Sexo" e fazer a contagem de casos confirmados. Depois, criamos um otro data frame com as mesmas variáveis, porém esse vai contar o número de mortes pela COVID-19. Por último, o DataFrame chamado "letalidade" foi responsável por calcular a taxa de letalidade da COVID-19. Vale ressaltar que a taxa de letalidade é a proporção entre o número de óbitos por uma doença em relação ao número de indivíduos acometidos por essa doença.

```{r message=F}
casos <- dados %>%
  group_by(RacaCor,Sexo) %>%
  summarise(n_casos = n())
mortes <- dados %>% 
  filter(Evolucao ==  "Óbito pelo COVID-19") %>%
  group_by(RacaCor,Sexo) %>%
  summarise(n_mortes = n())
letalidade <- inner_join(casos, mortes) %>%
  mutate(taxa_l =   ifelse(n_casos == 0, 0, 
                               round(100 * n_mortes / n_casos, 1)))

```


Certo, por último iremos plotar o gráfico

```{r message=F}
ggplot(letalidade) + geom_col(aes(x= RacaCor, y=taxa_l, fill= Sexo),position = "dodge") + 
  labs( x="Pessoas",
        y="Letalidade(%)",
        title="Taxa de letalidade da COVID-19 no ES") + 
  scale_fill_manual(values = c("yellow","purple")) + theme_bw()

```

Ao observamos o gráfico, notamos que a taxa de letalidade do sexo masculino é maior em relação ao sexo feminino em todas as raças. Além disso, notamos também que a taxa de letalidade de pessoas indigenas é a maior de todas as 6 registradas. Notamos também uma diferença muito grande em relação ao sexo feminino e masculino em pessoas pretas e brancas, principalmente, enquanto em pessoas amarelas existe um certo "equilibrio".










